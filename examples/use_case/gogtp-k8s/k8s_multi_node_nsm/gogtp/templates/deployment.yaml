{{ range $k, $v := .Values.apps }}
---
apiVersion: apps/v1
kind: Deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      networkservicemesh.io/app: {{ $k }}
  template:
    metadata:
      labels:
        networkservicemesh.io/app: {{ $k }}
        networkservicemesh.io/impl: {{ $.Chart.Name }}
    spec:
      containers:
      {{ if $v.endpoint }}
      - name: sidecar-nse
        image: nicoekkart/4g-network-sidecar-nse:latest
        imagePullPolicy: IfNotPresent
        env:
          - name: ENDPOINT_NETWORK_SERVICE
            value: "{{ $.Chart.Name }}"
          - name: ENDPOINT_LABELS
            value: "app={{ $k }}"
          - name: CLIENT_NETWORK_SERVICE
            value: "{{ $.Chart.Name }}"
          - name: CLIENT_LABELS
            value: "app={{ $k }}"
          - name: TRACER_ENABLED
            value: "true"
          #- name: IP_ADDRESS
          #  value: "10.60.1.0/24"
          - name: NSC_INTERFACE_NAME
            value: "{{ $k }}"
          - name: NSE_INTERFACE_NAME
            value: "{{ $k }}"
        resources:
          limits:
            networkservicemesh.io/socket: 1
      {{ end }}
      - name: {{ $.Chart.Name }}-{{ $k }}
        image: "soelvkaer/gogtp:{{$k}}"
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh","-c"]
        {{ if eq $k "enb" }}
        args:
          - sleep 30;
            ./root/enb_setup.sh;
            /usr/local/bin/enb -config /root/enb.yml;
        {{ else }}
        args:
          - ./root/{{$k}}_setup.sh;
            /usr/local/bin/{{$k}} -config /root/{{$k}}.yml;
        {{ end }}
        securityContext:
          privileged: true
        resources:
          limits:
            cpu: "3"
        volumeMounts:
        - name: gogtp-conf-{{$k}}
          mountPath: /root/
      volumes:
      - name: gogtp-conf-{{$k}}
        configMap:
          name: gogtp-conf-{{$k}}
          defaultMode: 0777
metadata:
  name: {{ $.Chart.Name }}-{{$k}}
  annotations:
    {{ if $v.networks }}
    ns.networkservicemesh.io: {{ $local := dict "first" true }}{{ range $i, $network := $v.networks }}{{ if not $local.first }},{{ end }}{{$.Chart.Name}}?app={{ $network }}{{ $_ := set $local "first" false }}{{ end }}
    {{ end }}
{{ end }}

{{ range $k, $v := .Values.endpoints }}
---
apiVersion: apps/v1
kind: Deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      networkservicemesh.io/app: {{ $k }}
  template:
    metadata:
      labels:
        networkservicemesh.io/app: {{ $k }}
        networkservicemesh.io/impl: {{ $.Chart.Name }}
    spec:
      containers:
      - name: {{ $.Chart.Name }}-{{$k}}
        image: "ubuntu:18.04"
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash","-c"]
        args: ["./root/setup.sh"]
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
        resources:
          limits:
            cpu: "3"
        volumeMounts:
        - name: gogtp-conf-{{$k}}
          mountPath: /root/
      volumes:
      - name: gogtp-conf-{{$k}}
        configMap:
          name: gogtp-conf-{{$k}}
          defaultMode: 0777
metadata:
  name: {{ $.Chart.Name }}-{{$k}}
  annotations:
    ns.networkservicemesh.io: {{ $local := dict "first" true }}{{ range $i, $network := $v.networks }}{{ if not $local.first }},{{ end }}{{$.Chart.Name}}?app={{ $network }}{{ $_ := set $local "first" false }}{{ end }}
{{ end }}
